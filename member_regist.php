<?php
// PHPã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
session_start();

// ----------------------------------------------------
// 0. å®šæ•°ã¨åˆæœŸè¨­å®š
// ----------------------------------------------------

// 47éƒ½é“åºœçœŒã®ãƒªã‚¹ãƒˆ
$prefectures = [
    'åŒ—æµ·é“', 'é’æ£®çœŒ', 'å²©æ‰‹çœŒ', 'å®®åŸçœŒ', 'ç§‹ç”°çœŒ', 'å±±å½¢çœŒ', 'ç¦å³¶çœŒ',
    'èŒ¨åŸçœŒ', 'æ ƒæœ¨çœŒ', 'ç¾¤é¦¬çœŒ', 'åŸ¼ç‰çœŒ', 'åƒè‘‰çœŒ', 'æ±äº¬éƒ½', 'ç¥å¥ˆå·çœŒ',
    'æ–°æ½ŸçœŒ', 'å¯Œå±±çœŒ', 'çŸ³å·çœŒ', 'ç¦äº•çœŒ', 'å±±æ¢¨çœŒ', 'é•·é‡çœŒ', 'å²é˜œçœŒ',
    'é™å²¡çœŒ', 'æ„›çŸ¥çœŒ', 'ä¸‰é‡çœŒ', 'æ»‹è³€çœŒ', 'äº¬éƒ½åºœ', 'å¤§é˜ªåºœ', 'å…µåº«çœŒ',
    'å¥ˆè‰¯çœŒ', 'å’Œæ­Œå±±çœŒ', 'é³¥å–çœŒ', 'å³¶æ ¹çœŒ', 'å²¡å±±çœŒ', 'åºƒå³¶çœŒ', 'å±±å£çœŒ',
    'å¾³å³¶çœŒ', 'é¦™å·çœŒ', 'æ„›åª›çœŒ', 'é«˜çŸ¥çœŒ', 'ç¦å²¡çœŒ', 'ä½è³€çœŒ', 'é•·å´çœŒ',
    'ç†Šæœ¬çœŒ', 'å¤§åˆ†çœŒ', 'å®®å´çœŒ', 'é¹¿å…å³¶çœŒ', 'æ²–ç¸„çœŒ'
];

// ã‚¹ãƒ†ãƒ¼ã‚¸ç®¡ç†
// 1: ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ› (form), 2: ç¢ºèªç”»é¢ (confirm), 3: å®Œäº†ç”»é¢ (complete)
$stage = isset($_SESSION['stage']) ? $_SESSION['stage'] : 1;
$errors = [];

// ----------------------------------------------------
// 1. ãƒ‡ãƒ¼ã‚¿å‡¦ç†ï¼ˆPOSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ï¼‰
// ----------------------------------------------------

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $action = $_POST['action'] ?? '';

    // ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ç¢ºèªç”»é¢ã¸ (stage 1 -> 2)
    if ($action === 'confirm') {
        // å…¥åŠ›å€¤ã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜
        $_SESSION['form_data'] = [
            'last_name' => trim($_POST['last_name'] ?? ''),
            'first_name' => trim($_POST['first_name'] ?? ''),
            'gender' => $_POST['gender'] ?? '',
            'prefecture' => $_POST['prefecture'] ?? '',
            'address' => trim($_POST['address'] ?? ''),
            'password' => $_POST['password'] ?? '',
            'password_confirm' => $_POST['password_confirm'] ?? '',
            'email' => trim($_POST['email'] ?? ''),
        ];

        // ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå…¥åŠ›ãƒã‚§ãƒƒã‚¯ï¼‰ã€‘
        $data = $_SESSION['form_data'];
        
        if (empty($data['last_name']) || empty($data['first_name'])) {
            $errors[] = 'æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        }
        if (empty($data['gender'])) {
            $errors[] = 'æ€§åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
        }
        if (empty($data['prefecture'])) {
            $errors[] = 'éƒ½é“åºœçœŒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
        }
        if (empty($data['address'])) {
            $errors[] = 'ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        }
        if (empty($data['password']) || empty($data['password_confirm'])) {
            $errors[] = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        }
        if (strlen($data['password']) < 8 || strlen($data['password']) > 20) {
             $errors[] = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8ã€œ20æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        }
        if ($data['password'] !== $data['password_confirm']) {
            $errors[] = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚';
        }
        if (!filter_var($data['email'], FILTER_VALIDATE_EMAIL)) {
            $errors[] = 'æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        }

        // ã‚¨ãƒ©ãƒ¼ãŒãªã‘ã‚Œã°ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’æ›´æ–°
        if (empty($errors)) {
            $stage = 2;
            $_SESSION['stage'] = 2;
        } else {
            // ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°ãƒ•ã‚©ãƒ¼ãƒ ã«ç•™ã¾ã‚‹
            $stage = 1;
            $_SESSION['stage'] = 1;
        }

    // ç¢ºèªç”»é¢ã‹ã‚‰ç™»éŒ²å®Œäº†ã¸ (stage 2 -> 3)
    } elseif ($action === 'register') {
        // ğŸš¨ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç™»éŒ²ãªã©ã®å‡¦ç†ã‚’ã“ã“ã§è¡Œã„ã¾ã™ ğŸš¨

        $stage = 3;
        $_SESSION['stage'] = 3;
        
        // ç™»éŒ²å®Œäº†å¾Œã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
        unset($_SESSION['form_data']);

    // ç¢ºèªç”»é¢ã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ ã¸æˆ»ã‚‹ (stage 2 -> 1)
    } elseif ($action === 'back') {
        $stage = 1;
        $_SESSION['stage'] = 1;
    }
}

// ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã‚„åˆã‚ã¦ã®ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã®åˆæœŸãƒ‡ãƒ¼ã‚¿è¨­å®š
if (!isset($_SESSION['form_data'])) {
    $_SESSION['form_data'] = [
        'last_name' => '', 'first_name' => '', 'gender' => '', 
        'prefecture' => '', 'address' => '', 'password' => '', 
        'password_confirm' => '', 'email' => ''
    ];
}

$formData = $_SESSION['form_data'];

// ----------------------------------------------------
// 2. HTMLã®å‡ºåŠ›ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ï¼‰
// ----------------------------------------------------

// ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã«å¿œã˜ã¦ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨­å®š
if ($stage === 1) {
    $title = 'ä¼šå“¡æƒ…å ±ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ';
} elseif ($stage === 2) {
    $title = 'ä¼šå“¡æƒ…å ±ç¢ºèªç”»é¢';
} else {
    $title = 'ä¼šå“¡ç™»éŒ²å®Œäº†';
}

// ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€HTMLã‚’å‡ºåŠ›
require_once 'member_regist.html.php';

// å®Œäº†ç”»é¢ã‹ã‚‰æˆ»ã‚‹éš›ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã‚„ã‚Šç›´ã™ï¼‰
if ($stage === 3) {
    unset($_SESSION['stage']);
}
?>
